user  nginx;
worker_processes  auto;

events { worker_connections 1024; }

http {
    # DNS داخلی Docker برای resolve در لحظه
    resolver 127.0.0.11 valid=10s ipv6=off;

    sendfile on;
    include       mime.types;
    default_type  application/octet-stream;

    server {
        listen 80;
        server_name _;

        # (اختیاری) سرو استاتیک
        location /static/ {
            alias /var/www/static/;
        }

        # --- OAuth2-Proxy plumbing ---
        location /oauth2/ {
            proxy_pass       http://oauth2-proxy:4180;
            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
        }

        location = /oauth2/auth {
            internal;
            proxy_pass       http://oauth2-proxy:4180/oauth2/auth;
            proxy_set_header X-Original-URL     $scheme://$http_host$request_uri;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Scheme           $scheme;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            
        }

        # --- مسیر آزاد ---
        location /public {
            proxy_pass       http://web:8000;
            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
        }

        # --- مسیر محافظت‌شده: استخراج و عبور هدرهای هویت ---
        location /private {
            # 1) تایید هویت
            auth_request /oauth2/auth;
            error_page 401 = /oauth2/start?rd=$request_uri;

            # 2) دریافت هدرهای هویت از پاسخ upstreamِ auth_request
            # انجینکس اطلاعات یوزر و ایمیل رو از اوس میگیره
            auth_request_set $user  $upstream_http_x_auth_request_user;
            auth_request_set $email $upstream_http_x_auth_request_email;

            # 3) عبور هویت به اپ (Django)
            # انجینکس اطلاعات کاربر و ایمیل رو که بالا از  اوس گرفته به جنگو میفرسه
            proxy_set_header X-User  $user;
            proxy_set_header X-Email $email;

            # 4) فوروارد به اپ
            proxy_pass       http://web:8000;
            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
        }

        # سایر مسیرها → اپ
        location / {
            proxy_pass       http://web:8000;
            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
        }
    }
}
